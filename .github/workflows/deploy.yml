name: Deploy Frontend to Server
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}  # â† Cambiado de 'key' a 'password'
        port: 22
        timeout: 30s
        command_timeout: 15m
        script: |
          cd /var/www/html/namu-frontend
          
          # Como git no funciona, descarga el repo como ZIP
          echo "ðŸ“¥ Downloading latest code..."
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               https://github.com/pakatnamu2022/namu-frontend/archive/refs/heads/main.zip \
               -o /tmp/repo.zip
          
          # Descomprime y actualiza
          apt install unzip -y 2>/dev/null || true
          unzip -o /tmp/repo.zip -d /tmp/
          
          # Backup del dist actual
          if [ -d "dist" ]; then
            mv dist dist_backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Copia archivos nuevos (excepto node_modules y dist)
          rsync -av --exclude='node_modules' --exclude='d
